#!/bin/bash

# Setup Load Balancer with IAP for Cloud Run
set -e

PROJECT_ID=${GCP_PROJECT_ID:-"newsletter-1757943207"}
REGION=${GCP_REGION:-"europe-west1"}
SERVICE_NAME="catalyst-newsletter"
NEG_NAME="${SERVICE_NAME}-neg"
BACKEND_SERVICE="${SERVICE_NAME}-backend"
URL_MAP="${SERVICE_NAME}-url-map"
TARGET_PROXY="${SERVICE_NAME}-https-proxy"
FORWARDING_RULE="${SERVICE_NAME}-forwarding-rule"
SSL_CERT="${SERVICE_NAME}-cert"
DOMAIN=${DOMAIN:-"catalyst.yourdomain.com"}

echo "üîß Setting up Load Balancer with IAP for Cloud Run"
echo "=================================================="
echo "Project: $PROJECT_ID"
echo "Region: $REGION"
echo "Service: $SERVICE_NAME"
echo ""

gcloud config set project $PROJECT_ID

# 1. Create Network Endpoint Group (NEG) for Cloud Run
echo "1Ô∏è‚É£ Creating Network Endpoint Group..."
gcloud compute network-endpoint-groups create $NEG_NAME \
  --region=$REGION \
  --network-endpoint-type=serverless \
  --cloud-run-service=$SERVICE_NAME

# 2. Create Backend Service
echo "2Ô∏è‚É£ Creating Backend Service..."
gcloud compute backend-services create $BACKEND_SERVICE \
  --global \
  --load-balancing-scheme=EXTERNAL \
  --protocol=HTTP

# 3. Add NEG to Backend Service
echo "3Ô∏è‚É£ Adding NEG to Backend Service..."
gcloud compute backend-services add-backend $BACKEND_SERVICE \
  --global \
  --network-endpoint-group=$NEG_NAME \
  --network-endpoint-group-region=$REGION

# 4. Create URL Map
echo "4Ô∏è‚É£ Creating URL Map..."
gcloud compute url-maps create $URL_MAP \
  --default-service=$BACKEND_SERVICE

# 5. Create SSL Certificate (managed by Google)
echo "5Ô∏è‚É£ Creating SSL Certificate..."
gcloud compute ssl-certificates create $SSL_CERT \
  --domains=$DOMAIN \
  --global || echo "Certificate exists"

# 6. Create HTTPS Proxy
echo "6Ô∏è‚É£ Creating HTTPS Proxy..."
gcloud compute target-https-proxies create $TARGET_PROXY \
  --url-map=$URL_MAP \
  --ssl-certificates=$SSL_CERT \
  --global

# 7. Create Forwarding Rule
echo "7Ô∏è‚É£ Creating Forwarding Rule..."
gcloud compute forwarding-rules create $FORWARDING_RULE \
  --load-balancing-scheme=EXTERNAL \
  --target-https-proxy=$TARGET_PROXY \
  --ports=443 \
  --global

# 8. Get the Load Balancer IP
LB_IP=$(gcloud compute forwarding-rules describe $FORWARDING_RULE --global --format="value(IPAddress)")

echo ""
echo "‚úÖ Load Balancer created successfully!"
echo "Load Balancer IP: $LB_IP"
echo ""
echo "üìã Next Steps:"
echo ""
echo "1. Update your DNS:"
echo "   Point $DOMAIN to $LB_IP"
echo ""
echo "2. Enable IAP in Console:"
echo "   https://console.cloud.google.com/security/iap?project=$PROJECT_ID"
echo "   - You should now see: $BACKEND_SERVICE"
echo "   - Toggle IAP to ON for this backend service"
echo ""
echo "3. Configure OAuth:"
echo "   - Create OAuth 2.0 Client ID if not already done"
echo "   - Configure IAP with the OAuth client"
echo ""
echo "4. Grant access to users:"
echo "   gcloud iap web add-iam-policy-binding \\"
echo "     --resource-type=backend-services \\"
echo "     --service=$BACKEND_SERVICE \\"
echo "     --member='user:email@domain.com' \\"
echo "     --role='roles/iap.httpsResourceAccessor'"